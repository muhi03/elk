import{_ as de}from"./C5_5OrRM.js";import{d as F,aj as ae,ak as se,e as _,o as m,a5 as W,Q as P,g as i,a2 as ce,t as h,aO as pe,F as fe,r as E,f as g,as as be,q as S,_ as ve,G as I,a8 as me,c as H,x as b,af as he,H as le,h as t,aP as re,aQ as Y,a as ye,i as ge,A as $,ad as J,aR as _e,aS as we,aa as ke,aT as x,l as $e,aE as Ve,aU as Se,p as X,M as Ne,aV as L,a4 as Z}from"./vIUoIwJY.js";const Pe={"flex-1":"","ms-2":"","pointer-events-none":""},Ce=["value"],Ee=F({__name:"CommonRadio",props:ae({label:{},value:{},hover:{type:Boolean}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(a){const e=se(a,"modelValue");return(n,o)=>(m(),_("label",{class:P(["common-radio flex items-center cursor-pointer py-1 text-md w-full gap-y-1",n.hover?"hover:bg-active ms--2 px-4 py-2":null]),onClick:o[1]||(o[1]=W(d=>e.value=n.value,["prevent"]))},[i("span",Pe,h(n.label),1),i("span",{class:P(e.value===n.value?"i-ri:radio-button-line":"i-ri:checkbox-blank-circle-line"),"aria-hidden":"true"},null,2),ce(i("input",{"onUpdate:modelValue":o[0]||(o[0]=d=>e.value=d),type:"radio",value:n.value,"sr-only":""},null,8,Ce),[[pe,e.value]])],2))}}),xe={key:0,role:"alert","aria-describedby":"notification-failed",flex:"~ col","gap-1":"","text-sm":"","pt-1":"","ps-2":"","pe-1":"","pb-2":"","text-red-600":"","dark:text-red-400":"",border:"~ base rounded red-600 dark:red-400"},Ue={id:"notification-failed",flex:"","justify-between":""},Ae={flex:"","items-center":"","gap-x-2":"","font-bold":""},Te=["aria-label"],Me={"py-2":""},Be={"py-2":""},Ie=F({__name:"NotificationSubscribePushNotificationError",props:ae({title:{},message:{}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(a){const e=se(a,"modelValue");return(n,o)=>{const d=be,c=ve,u=fe("i18n-t");return e.value?(m(),_("div",xe,[i("header",Ue,[i("div",Ae,[o[1]||(o[1]=i("div",{"aria-hidden":"true","i-ri:error-warning-fill":""},null,-1)),i("p",null,h(n.title??n.$t("settings.notifications.push_notifications.subscription_error.title")),1)]),g(d,{placement:"bottom",content:n.$t("settings.notifications.push_notifications.subscription_error.clear_error")},{default:S(()=>[i("button",{flex:"","rounded-4":"",p1:"","hover:bg-active":"","cursor-pointer":"","transition-100":"","aria-label":n.$t("settings.notifications.push_notifications.subscription_error.clear_error"),onClick:o[0]||(o[0]=y=>e.value=!1)},o[2]||(o[2]=[i("span",{"aria-hidden":"true",w:"1.75em",h:"1.75em","i-ri:close-line":""},null,-1)]),8,Te)]),_:1},8,["content"])]),i("p",null,h(n.message),1),i("p",Me,[g(u,{keypath:"settings.notifications.push_notifications.subscription_error.error_hint"},{default:S(()=>[g(c,{"font-bold":"",href:"https://docs.elk.zone/pwa#faq",target:"_blank","inline-flex":"~ row","items-center":"","gap-x-2":""},{default:S(()=>o[3]||(o[3]=[I(" https://docs.elk.zone/pwa#faq "),i("span",{"inline-block":"","aria-hidden":"true","i-ri:external-link-line":"",class:"rtl-flip"},null,-1)])),_:1})]),_:1})]),i("p",Be,[g(c,{"font-bold":"","text-primary":"",href:"https://github.com/elk-zone/elk",target:"_blank",flex:"~ row","items-center":"","gap-x-2":""},{default:S(()=>[I(h(n.$t("settings.notifications.push_notifications.subscription_error.repo_link"))+" ",1),o[4]||(o[4]=i("span",{"inline-block":"","aria-hidden":"true","i-ri:external-link-line":"",class:"rtl-flip"},null,-1))]),_:1})])])):E("",!0)}}}),Oe={flex:"","items-center":"","pb-2":""},Ke={id:"notifications-warning","text-md":"","font-bold":"","w-full":""},Re=["title","disabled"],De={"xl:hidden":""},qe={"xl:hidden":""},He={key:1},Fe={key:2},je=["disabled"],ze={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},Le={key:1,"aria-hidden":"true",block:"","i-ri:check-line":""},We=F({__name:"NotificationEnablePushNotification.client",props:{closeableHeader:{type:Boolean},busy:{type:Boolean},animate:{type:Boolean}},emits:["hide","subscribe"],setup(a){const e=me("(min-width: 1280px)"),n=H(()=>!b.value?.vapidKey);return(o,d)=>(m(),_("div",{flex:"~ col","gap-y-2":"",role:"alert","aria-labelledby":"notifications-warning",class:P(o.closeableHeader?"border-b border-base":"px6 px4")},[i("header",Oe,[i("h2",Ke,h(o.$t("settings.notifications.push_notifications.warning.enable_title")),1),o.closeableHeader?(m(),_("button",{key:0,flex:"","rounded-4":"",type:"button",title:o.$t("settings.notifications.push_notifications.warning.enable_close"),"hover:bg-active":"","cursor-pointer":"","transition-100":"",disabled:o.busy,onClick:d[0]||(d[0]=c=>o.$emit("hide"))},d[2]||(d[2]=[i("span",{"aria-hidden":"true","i-ri:close-line":""},null,-1)]),8,Re)):E("",!0)]),o.closeableHeader?(m(),_(le,{key:0},[i("p",De,h(o.$t("settings.notifications.push_notifications.warning.enable_description")),1),i("p",qe,h(o.$t("settings.notifications.push_notifications.warning.enable_description_mobile")),1),i("p",{class:P(t(e)?null:"hidden")},h(o.$t("settings.notifications.push_notifications.warning.enable_description_desktop")),3)],64)):(m(),_("p",He,h(o.$t("settings.notifications.push_notifications.warning.enable_description_settings")),1)),t(n)?(m(),_("p",Fe,h(o.$t("settings.notifications.push_notifications.warning.re_auth")),1)):E("",!0),i("button",{"btn-outline":"","rounded-full":"","font-bold":"",py4:"",flex:"~ gap2 center",m5:"",type:"button",class:P(o.busy||t(n)?"border-transparent":null),disabled:o.busy||t(n),onClick:d[1]||(d[1]=c=>o.$emit("subscribe"))},[o.busy&&o.animate?(m(),_("span",ze,d[3]||(d[3]=[i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1)]))):(m(),_("span",Le)),i("span",null,h(o.$t("settings.notifications.push_notifications.warning.enable_desktop")),1)],10,je),he(o.$slots,"error")],2))}});class q extends Error{code;constructor(e,n){super(n),this.code=e}}async function Ye(a,e,n="all",o=!1){const{server:d,vapidKey:c}=a;return await ee().then(te).then(({registration:u,subscription:y})=>{if(y){const N=new Uint8Array(y.options.applicationServerKey).toString();if(ue(c).toString()===N&&y.endpoint===d&&!o&&a.pushSubscription)return Promise.resolve(a.pushSubscription);if(a.pushSubscription)return ie(!1,!1).catch(Ge).then(()=>oe(u,c)).then(A=>ne(A,e,n))}return oe(u,c).then(N=>ne(N,e,n))}).catch(u=>{let y=u;return u.code===11&&u.name==="InvalidStateError"?y=new q("too_many_registrations","Too many registrations"):u.code===20&&u.name==="AbortError"?y=new q("vapid_not_supported","Your browser supports Web Push Notifications, but does not seem to implement the VAPID protocol."):u.code===5&&u.name==="InvalidCharacterError"&&(y=new q("invalid_vapid_key",`The VAPID public key seems to be invalid: ${c}`)),ee().then(te).then(()=>ie(!0)).then(()=>Promise.resolve(void 0)).catch(N=>Promise.resolve(void 0)).finally(()=>Promise.reject(y))})}function ue(a){const e="=".repeat((4-a.length%4)%4),n=`${a}${e}`.replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(n),d=new Uint8Array(o.length);for(let c=0;c<o.length;++c)d[c]=o.charCodeAt(c);return d}function ee(){return navigator.serviceWorker.ready}async function te(a){const e=await a.pushManager.getSubscription();return{registration:a,subscription:e}}async function oe(a,e){return await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ue(e)})}async function ie(a,e=!0){const n=b.value;n&&(await re(n),e&&await Y(n,a))}async function Ge(a){const e=b.value;throw e&&await Y(e,!0),a}async function ne(a,e,n){const{endpoint:o,keys:d}=a.toJSON();return await ye().v1.push.subscription.create({policy:n,subscription:{endpoint:o,keys:{p256dh:d.p256dh,auth:d.auth}},data:e})}const Qe=typeof window<"u"&&"serviceWorker"in navigator&&"PushManager"in window&&"getKey"in PushSubscription.prototype;function Je(){const{client:a}=ge(),e=$(!1),n=$(Notification.permission==="denied"?"denied":Notification.permission==="granted"?"granted":Notification.permission==="default"?"prompt":void 0),o=H(()=>Qe),d=J(_e,{}),c=J(we,{}),u=$(D(b.value?.pushSubscription,c.value[b.value?.account?.acct??""])),y=$(D(b.value?.pushSubscription,c.value[b.value?.account?.acct??""])),N=H(()=>{const l=u.value,p=y.value;return l.favourite!==p.favourite||l.reblog!==p.reblog||l.mention!==p.mention||l.follow!==p.follow||l.poll!==p.poll||l.policy!==p.policy});ke(()=>b.value?.pushSubscription,l=>{e.value=!!l,u.value=D(l,c.value[b.value?.account?.acct??""]),y.value=D(l,c.value[b.value?.account?.acct??""])},{immediate:!0,flush:"post"});const U=async(l,p,V)=>{if(!o.value)return"not-supported";if(!b.value)return"no-user";const{pushSubscription:w,server:k,token:O,vapidKey:M,account:{acct:z}}=b.value;if(!O||!k||!M)return"invalid-vapid-key";const C=await Promise.resolve(Notification.requestPermission()).then(K=>K==="default"?"prompt":K);return C==="denied"?(n.value=C,"notification-denied"):(b.value.pushSubscription=await Ye({pushSubscription:w,server:k,vapidKey:M},l??{alerts:{follow:!0,favourite:!0,reblog:!0,mention:!0,poll:!0}},p??"all",V),await x(),n.value=C,d.value[z]=!0,"subscribed")},A=async()=>{if(!o.value||!e.value||!b.value)return!1;await re(b.value),await Y(b.value)},T=async l=>{l&&(u.value.policy=l);const p=u.value;y.value={favourite:p.favourite,reblog:p.reblog,mention:p.mention,follow:p.follow,poll:p.poll,policy:p.policy},l?c.value[b.value.account.acct??""]=l:c.value[b.value.account.acct??""]=u.value.policy,await x()};return{pushNotificationData:u,saveEnabled:N,undoChanges:()=>{const l=y.value;u.value={favourite:l.favourite,reblog:l.reblog,mention:l.mention,follow:l.follow,poll:l.poll,policy:l.policy},c.value[b.value.account.acct??""]=l.policy},hiddenNotification:d,isSupported:o,isSubscribed:e,notificationPermission:n,updateSubscription:async()=>{if(b.value){const l=y.value,p={alerts:{follow:u.value.follow,favourite:u.value.favourite,reblog:u.value.reblog,mention:u.value.mention,poll:u.value.poll}},V=u.value.policy,w=l.policy!==V;w?await U(p,V,!0):b.value.pushSubscription=await a.value.v1.push.subscription.update({data:p}),w&&await x(),await T(w?V:void 0)}},subscribe:U,unsubscribe:A}}function D(a,e){return{follow:a?.alerts.follow??!0,favourite:a?.alerts.favourite??!0,reblog:a?.alerts.reblog??!0,mention:a?.alerts.mention??!0,poll:a?.alerts.poll??!0,policy:e??"all"}}const Xe=Ne(We),Ze={key:0,"aria-labelledby":"pn-s"},et={key:0,flex:"~ col",border:"b base"},tt={id:"pn-settings",px6:"",py4:"",mt2:"","font-bold":"","text-xl":"",flex:"~ gap-1","items-center":""},ot={key:0,flex:"~ col"},it={id:"pn-instructions","text-sm":"",pb2:"","aria-hidden":"true"},nt={flex:"~ col","gap-y-1":"","py-1":""},at={flex:"~ col","gap-y-1":"","py-1":""},st={flex:"~ col","gap-y-4":"","gap-x-2":"","py-1":"",sm:"~ justify-between flex-row"},lt=["disabled"],rt={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},ut={key:1,block:"","aria-hidden":"true","i-ri:save-2-fill":""},dt=["disabled"],ct=["disabled"],pt={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},ft={key:1,block:"","aria-hidden":"true","i-material-symbols:cancel-rounded":""},bt={key:1,px6:"",pb4:"",role:"alert","aria-labelledby":"n-unsupported"},vt={id:"n-unsupported"},yt=F({__name:"NotificationPreferences.client",props:{show:{type:Boolean}},setup(a){const{pushNotificationData:e,saveEnabled:n,undoChanges:o,hiddenNotification:d,isSubscribed:c,isSupported:u,notificationPermission:y,updateSubscription:N,subscribe:U,unsubscribe:A}=Je(),{t:T}=$e(),j=Ve().pwaEnabled,v=$(!1),l=$(!1),p=$(!1),V=$(!1),w=$(""),k=$(!1);function O(){const r=b.value?.account?.acct;r&&(d.value[r]=!0)}const M=H(()=>j?u&&(!c.value||!y.value||y.value==="prompt")&&!d.value[b.value?.account?.acct??""]:!1);async function z(){if(!v.value){v.value=!0,await x(),l.value=!0;try{await N()}catch{}finally{v.value=!1,l.value=!1}}}async function C(){if(!v.value){v.value=!0,await x(),p.value=!0;try{const r=await U();r!=="subscribed"&&(w.value=T(`settings.notifications.push_notifications.subscription_error.${r==="notification-denied"?"permission_denied":"request_error"}`),k.value=!0)}catch(r){r instanceof q?w.value=T(`settings.notifications.push_notifications.subscription_error.${r.code}`):w.value=T("settings.notifications.push_notifications.subscription_error.request_error"),k.value=!0}finally{v.value=!1,p.value=!1}}}async function K(){if(!v.value){v.value=!0,await x(),V.value=!0;try{await A()}catch{}finally{v.value=!1,V.value=!1}}}return Se(()=>v.value=!1),(r,s)=>{const B=de,R=Ee,G=Ie,Q=Xe;return t(j)&&(t(M)||r.show)?(m(),_("section",Ze,[g(L,{name:"slide-down"},{default:S(()=>[r.show?(m(),_("div",et,[i("h3",tt,h(r.$t("settings.notifications.push_notifications.label")),1),t(u)?(m(),_(le,{key:0},[t(c)?(m(),_("div",ot,[i("form",{flex:"~ col","gap-y-2":"",px6:"",pb4:"",onSubmit:W(z,["prevent"])},[i("p",it,h(r.$t("settings.notifications.push_notifications.instructions")),1),i("fieldset",nt,[i("legend",null,h(r.$t("settings.notifications.push_notifications.alerts.title")),1),g(B,{modelValue:t(e).follow,"onUpdate:modelValue":s[0]||(s[0]=f=>t(e).follow=f),hover:"",label:r.$t("settings.notifications.push_notifications.alerts.follow")},null,8,["modelValue","label"]),g(B,{modelValue:t(e).favourite,"onUpdate:modelValue":s[1]||(s[1]=f=>t(e).favourite=f),hover:"",label:r.$t("settings.notifications.push_notifications.alerts.favourite")},null,8,["modelValue","label"]),g(B,{modelValue:t(e).reblog,"onUpdate:modelValue":s[2]||(s[2]=f=>t(e).reblog=f),hover:"",label:r.$t("settings.notifications.push_notifications.alerts.reblog")},null,8,["modelValue","label"]),g(B,{modelValue:t(e).mention,"onUpdate:modelValue":s[3]||(s[3]=f=>t(e).mention=f),hover:"",label:r.$t("settings.notifications.push_notifications.alerts.mention")},null,8,["modelValue","label"]),g(B,{modelValue:t(e).poll,"onUpdate:modelValue":s[4]||(s[4]=f=>t(e).poll=f),hover:"",label:r.$t("settings.notifications.push_notifications.alerts.poll")},null,8,["modelValue","label"])]),i("fieldset",at,[i("legend",null,h(r.$t("settings.notifications.push_notifications.policy.title")),1),g(R,{modelValue:t(e).policy,"onUpdate:modelValue":s[5]||(s[5]=f=>t(e).policy=f),hover:"",value:"all",label:r.$t("settings.notifications.push_notifications.policy.all")},null,8,["modelValue","label"]),g(R,{modelValue:t(e).policy,"onUpdate:modelValue":s[6]||(s[6]=f=>t(e).policy=f),hover:"",value:"followed",label:r.$t("settings.notifications.push_notifications.policy.followed")},null,8,["modelValue","label"]),g(R,{modelValue:t(e).policy,"onUpdate:modelValue":s[7]||(s[7]=f=>t(e).policy=f),hover:"",value:"follower",label:r.$t("settings.notifications.push_notifications.policy.follower")},null,8,["modelValue","label"]),g(R,{modelValue:t(e).policy,"onUpdate:modelValue":s[8]||(s[8]=f=>t(e).policy=f),hover:"",value:"none",label:r.$t("settings.notifications.push_notifications.policy.none")},null,8,["modelValue","label"])]),i("div",st,[i("button",{"btn-solid":"","font-bold":"",py2:"","full-w":"","sm-wa":"",flex:"~ gap2 center",class:P(t(v)||!t(n)?"border-transparent":null),disabled:t(v)||!t(n)},[t(v)&&t(l)?(m(),_("span",rt,s[12]||(s[12]=[i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1)]))):(m(),_("span",ut)),I(" "+h(r.$t("settings.notifications.push_notifications.save_settings")),1)],10,lt),i("button",{"btn-outline":"","font-bold":"",py2:"","full-w":"","sm-wa":"",flex:"~ gap2 center",type:"button",class:P(t(v)||!t(n)?"border-transparent":null),disabled:t(v)||!t(n),onClick:s[9]||(s[9]=(...f)=>t(o)&&t(o)(...f))},[s[13]||(s[13]=i("span",{"aria-hidden":"true",class:"block i-material-symbols:undo-rounded"},null,-1)),I(" "+h(r.$t("settings.notifications.push_notifications.undo_settings")),1)],10,dt)])],32),i("form",{flex:"~ col","mt-4":"",onSubmit:W(K,["prevent"])},[s[15]||(s[15]=i("span",{border:"b base 2px",class:"bg-$c-text-secondary"},null,-1)),i("button",{"btn-outline":"","rounded-full":"","font-bold":"","py-4":"",flex:"~ gap2 center",m5:"",class:P(t(v)?"border-transparent":null),disabled:t(v)},[t(v)&&t(V)?(m(),_("span",pt,s[14]||(s[14]=[i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1)]))):(m(),_("span",ft)),I(" "+h(r.$t("settings.notifications.push_notifications.unsubscribe")),1)],10,ct)],32)])):(m(),X(Q,{key:1,animate:t(p),busy:t(v),onHide:O,onSubscribe:C},{error:S(()=>[g(L,{name:"slide-down"},{default:S(()=>[g(G,{modelValue:t(k),"onUpdate:modelValue":s[10]||(s[10]=f=>Z(k)?k.value=f:null),message:t(w)},null,8,["modelValue","message"])]),_:1})]),_:1},8,["animate","busy"]))],64)):(m(),_("div",bt,[i("p",vt,h(r.$t("settings.notifications.push_notifications.unsupported")),1)]))])):E("",!0)]),_:1}),t(M)&&!r.show?(m(),X(Q,{key:0,"closeable-header":"",px5:"",py4:"",animate:t(p),busy:t(v),onHide:O,onSubscribe:C},{error:S(()=>[g(L,{name:"slide-down"},{default:S(()=>[g(G,{modelValue:t(k),"onUpdate:modelValue":s[11]||(s[11]=f=>Z(k)?k.value=f:null),message:t(w)},null,8,["modelValue","message"])]),_:1})]),_:1},8,["animate","busy"])):E("",!0)])):E("",!0)}}});export{yt as _};
